# Документация распределённой системы хранения файлов

## 1. Общая характеристика системы

Система предназначена для распределённого хранения файлов с возможностью потоковой загрузки и скачивания, возобновления прерванных загрузок, финализации переданных данных и автоматической очистки незавершённых операций.  
Архитектура разделена на три изолированных компонента:

- **Сервис Координатора** — управляет метаданными, маршрутизацией загрузок, финализацией и очисткой.
- **Сервис Узла Хранения (DataNode)** — непосредственно записывает и выдаёт файловые данные.
- **Клиентское приложение (CLI)** — предоставляет пользователю команды для загрузки, возобновления и скачивания файлов.

Взаимодействие между компонентами осуществляется по gRPC.  
Метаданные хранятся в JSON‑формате и сохраняются между перезапусками.

---

## 2. Архитектура и взаимодействие компонентов

### 2.1. Сервис Координатора

Функции:

1. Регистрация и снятие зарегистрированных узлов хранения.
2. Выбор узла хранения при начале загрузки файла.
3. Создание, обновление и хранение метаданных о файлах.
4. Подтверждение завершённой загрузки (финализация).
5. Проверка согласованности данных посредством запроса статистики у DataNode.
6. Запуск процедуры очистки устаревших или незавершённых загрузок.
7. Предоставление gRPC‑методов для взаимодействия с клиентом.

Структура хранимых метаданных включает:
- путь файла в хранилище;
- идентификатор загрузки (uploadId);
- адрес узла хранения;
- статус загрузки (`UPLOADING`, `FINALIZED`);
- ожидаемый размер файла;
- количество переданных байт и индекс последнего чанка;
- временные метки создания и финализации.

Все метаданные сохраняются в файл `metadata.json`.

---

### 2.2. Узел хранения (DataNode)

Функции:

1. Приём потоковой загрузки файла от клиента.
2. Сохранение чанков на локальный диск.
3. Передача файла клиенту по частям при скачивании.
4. Предоставление информации о текущем состоянии загрузки.
5. Удаление данных незавершённых загрузок по запросу координатора.
6. Регистрация у координатора при старте.

Каждый DataNode хранит данные только своей зоны ответственности. Файлы размещаются в директории `/app/data/<uploadId>/`.

---

### 2.3. Клиентское приложение (CLI)

Функции:

1. Загрузка локального файла в хранилище.
2. Возобновление ранее начатой загрузки.
3. Получение файла из хранилища.
4. Отображение хода передачи данных (прогресс‑бар).
5. Автоматическое создание gRPC‑каналов к координатору и DataNode.

Команды CLI:

- `upload <remotePath> <localPath>`
- `resume-upload <remotePath> <localPath>`
- `download <remotePath> <localPath>`

---

## 3. Потоки данных

### 3.1. Поток загрузки файла

1. Клиент запрашивает у Координатора начало загрузки.
2. Координатор выбирает подходящий DataNode и создаёт запись метаданных.
3. Клиент инициирует потоковое соединение с DataNode.
4. Файл разбивается на последовательность чанков фиксированного размера и отправляется.
5. После отправки клиент запрашивает финализацию у Координатора.
6. Координатор обращается к DataNode для проверки фактического объёма данных.
7. При совпадении размеров запись переводится в статус `FINALIZED`.

---

### 3.2. Поток скачивания файла

1. Клиент запрашивает у Координатора начало скачивания.
2. Координатор возвращает адрес DataNode и характеристики файла.
3. Клиент открывает потоковое соединение с DataNode и получает последовательность чанков до полного чтения файла.

---

### 3.3. Очистка незавершённых загрузок

Координатор по расписанию:

1. Находит все загрузки в статусе `UPLOADING`, превышающие допускаемый порог времени.
2. Запрашивает у соответствующих DataNode удаление данных.
3. Удаляет запись из `metadata.json`.

---

## 4. Конфигурация

Все параметры могут быть заданы через переменные окружения.

### 4.1. Сервис Координатора

- `GRPC_SERVER_PORT` — порт gRPC‑сервера (по умолчанию 50060)
- `COORDINATOR_STORAGE_PATH` — путь к файлу метаданных
- `COORDINATOR_CLEANUP_INTERVAL_MS` — период запуска очистки
- `COORDINATOR_CLEANUP_TIMEOUT_MS` — максимальный возраст незавершённой загрузки
- `COORDINATOR_CHUNK_SIZE` — рекомендуемый размер чанка

### 4.2. Узел хранения

- `GRPC_SERVER_PORT` — порт gRPC‑сервера
- `DATANODE_ADVERTISED_HOST` — адрес узла, используемый координатором
- `DATANODE_STORAGE_PATH` — каталог хранения файлов
- `COORDINATOR_HOST`, `COORDINATOR_PORT` — адрес координатора

### 4.3. Клиент

- `COORDINATOR_HOST`
- `COORDINATOR_PORT`

---

## 5. Запуск системы

### Требования
- Docker  
- Docker Compose  

### Запуск
```
docker compose up --build
```

После старта контейнеров проверка состояния:
```
docker compose ps
```

Ожидается, что координатор и узлы хранения находятся в состоянии `healthy`.

---

## 6. Примеры использования клиентского интерфейса

### 6.1. Загрузка файла
```
docker exec -it storage-client sh
echo "данные" > example.txt
java -jar app.jar upload /remote/example.txt /app/example.txt
```

### 6.2. Возобновление
```
java -jar app.jar resume-upload /remote/example.txt /app/example.txt
```

### 6.3. Скачивание
```
java -jar app.jar download /remote/example.txt /app/out.txt
```

---

## 7. Структура метаданных

Файл `metadata.json` содержит массив объектов следующего вида:

```json
{
  "filePath": "/remote/example.txt",
  "uploadId": "uuid",
  "dataNodeAddress": "datanode1:50051",
  "status": "FINALIZED",
  "fileSize": 12345,
  "createdAt": 1765136566861,
  "finalizedAt": 1765136566936,
  "lastChunkIndex": 10,
  "bytesUploaded": 65536
}
```

Все записи автоматически обновляются при изменениях состояния загрузки.
